generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// 1. USER & PROFILE (Linked to Supabase Auth)
// ==========================================
model User {
  id            String   @id @default(uuid())
  // This email/username comes from Supabase Auth
  email         String   @unique 
  username      String   @unique
  avatarUrl     String?
  
  // Ranking System Data
  rankTier      String   @default("BRONZE") // BRONZE, SILVER, GOLD, DIAMOND
  mmr           Int      @default(1000)     // Matchmaking Rating
  matchesPlayed Int      @default(0)
  
  createdAt     DateTime @default(now())
  
  // Relations
  matchHistory  MatchParticipant[]
  proposals     KeyProposal[]
}

// ==========================================
// 2. MATCHMAKING QUEUE
// ==========================================
// Users sit here temporarily while waiting for a game
model QueueEntry {
  userId    String   @id
  rankTier  String   // e.g. "SILVER"
  mmr       Int      // For MMR-based matching
  joinedAt  DateTime @default(now())
  
  @@index([rankTier, mmr])
}

// ==========================================
// 3. THE MATCH (The Container)
// ==========================================
model Match {
  id          String       @id @default(uuid())
  status      MatchStatus  @default(ACTIVE)
  
  // The "State Machine" Phase
  phase       GamePhase    @default(GUIDELINES) 
  
  // The Winning Secret Key (Hidden from Detective via RLS)
  finalKey    String?   
  
  roundsToPlay      Int      @default(4)
  currentRoundNumber Int      @default(0)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  endedAt     DateTime?

  // Relations
  participants MatchParticipant[]
  rounds       Round[]
  proposals    KeyProposal[]
  
  @@index([phase, status])
  @@index([status])
}

// Enum for Game Phases (Type Safety)
enum GamePhase {
  GUIDELINES      // Tutorial Screen
  KEY_SELECTION   // Spies Voting
  PLAYING         // Drawing & Guessing
  HALFTIME        // Role Swap
  FINISHED        // Game Over
}

enum MatchStatus {
  ACTIVE
  FINISHED
  CANCELLED
}

enum ParticipantStatus {
  JOINED
  READY
  DISCONNECTED
}

// ==========================================
// 4. PARTICIPANTS (Players in a Match)
// ==========================================
model MatchParticipant {
  id        String            @id @default(uuid())
  matchId   String
  userId    String
  
  // Their role in THIS specific match (Rotates!)
  role      Role              @default(SPECTATOR)
  status    ParticipantStatus @default(JOINED)
  score     Int               @default(0)
  ready     Boolean           @default(false)
  mmrSnapshot Int?            // MMR at join time for reporting
  
  // Relations
  match     Match    @relation(fields: [matchId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  
  @@unique([matchId, userId])
  @@index([matchId, role])
  @@index([matchId, status])
}

enum Role {
  SPY
  DETECTIVE
  SPECTATOR // For dead players or observers
}

// ==========================================
// 5. VOTING SYSTEM (The War Room)
// ==========================================
model KeyProposal {
  id        String   @id @default(uuid())
  matchId   String
  userId    String   // The Spy who proposed it
  
  text      String   // The proposed key (e.g., "FIRE")
  votes     Int      @default(0)
  
  // Relations
  match     Match    @relation(fields: [matchId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

// ==========================================
// 6. ROUNDS (The Action)
// ==========================================
model Round {
  id          String   @id @default(uuid())
  matchId     String
  roundNumber Int
  
  drawerId    String   // Which Spy is drawing?
  targetWord  String   // The word to draw (e.g. "SUN")
  
  winnerId    String?  // Who guessed correctly first?
  winnerTeam  String?  // SPY or DETECTIVE
  startedAt   DateTime @default(now())
  endedAt     DateTime?

  match       Match    @relation(fields: [matchId], references: [id])
  
  @@index([matchId, roundNumber])
}

model GuessAttempt {
  id            String   @id @default(uuid())
  matchId       String
  roundId       String
  participantId String   // FK to MatchParticipant
  text          String
  isCorrect     Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  @@index([matchId, roundId])
  @@index([participantId])
}